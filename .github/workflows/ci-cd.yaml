name: CI/CD Pipeline

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  cache:
    uses: ./.github/workflows/cache-uv-build.yaml

  lint:
    uses: ./.github/workflows/ruff.yaml
    needs: cache

  test:
    needs: [lint, cache]
    uses: ./.github/workflows/pytest.yaml

  docker:
    if: github.event_name == 'push'
    needs: test
    uses: ./.github/workflows/docker-build-and-scan.yaml
    with:
      DOCKER_PATH_CONTEXT: .
      DOCKER_BUILD_DOCKERFILE: ./Dockerfile
      DOCKER_TAGS: ${{ github.repository }}:${{ github.sha }}
      DOCKER_LOAD_BOOL: false
      DOCKER_PUSH_BOOL: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') }}
    secrets: inherit

  release:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    needs: [test, docker]
    uses: ./.github/workflows/release.yaml
    permissions:
      contents: write
    secrets: inherit
